<!doctype html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario</title>

<style>
body{font-family:system-ui;margin:6px}
h1{text-align:center;margin-bottom:8px;font-size:22px}

.top{display:flex;gap:6px;margin-bottom:8px}
select{flex:1;padding:6px;font-size:18px;border-radius:6px}

.grid{
    display:grid;grid-template-columns:repeat(3,1fr);
    gap:4px;margin-bottom:4px;
}
.box{border:1px solid #555;border-radius:4px;padding:2px;text-align:center}
.value{font-size:17px;font-weight:bold}
.highlight{background:#c2e4ff}

.keypad{
    display:grid;grid-template-columns:repeat(3,1fr);
    gap:4px;margin-top:6px;
}
.kp{padding:12px;font-size:20px;border:none;border-radius:6px;background:#dcdcdc}

.rowBtns{display:flex;gap:6px;justify-content:center;margin-top:6px}
button{padding:8px 12px;font-size:18px;border:none;border-radius:5px}
.save{background:#00a82d;color:white}
.back{background:#333;color:white}
.plus{background:#ff9c00;font-size:22px;color:#fff}
</style>
</head>

<body>

<h1>Inventario por Piso</h1>

<div class="top">
 <select id="piso"></select>
</div>

<div id="grid" class="grid"></div>

<div class="rowBtns">
  <button id="prev">◀</button>
  <button id="plus" class="plus">+</button>
  <button id="next">▶</button>
  <button id="clear">C</button>
</div>

<div id="keys" class="keypad"></div>

<div class="rowBtns">
  <button id="save"  class="save">Guardar</button>
  <button id="back"  class="back" onclick="location.href='index.html'">Volver</button>
</div>

<script>
const campos=["B","T","P","SG","SCH","F","K","3SG","3SCH","3K","ocupacion"]

function loadBase(){return JSON.parse(localStorage.getItem("lbase")||"{}")}
function inv(){return JSON.parse(localStorage.getItem("linv")||"{}")}
function saveInv(x){localStorage.setItem("linv",JSON.stringify(x))}

async function cargarBaseDesdeTxt(){
    let txt=await fetch("base.txt").then(r=>r.text())
    let l=txt.trim().split("\n").map(x=>x.split(","))
    let h=l[0]; let out={}
    l.slice(1).forEach(row=>{
        let o={}; row.forEach((v,i)=>o[h[i]]=v)
        out[o.piso]={king:+o.king,queen:+o.queen,twin:+o.twin,"3ra_sabana":o["3ra_sabana"]}
    })
    localStorage.setItem("lbase",JSON.stringify(out))
 }

async function start(){
    await cargarBaseDesdeTxt()

    let base=loadBase(),sel=document.getElementById("piso")
    Object.keys(base).forEach(p=>sel.innerHTML+=`<option>${p}</option>`)

    buildGrid()
    loadValues(sel.value)

    sel.onchange=()=>loadValues(sel.value)
}
start()

function buildGrid(){
    let g=document.getElementById("grid"); g.innerHTML=""
    campos.forEach(c=>{
        g.innerHTML+=`<div class="box">${c}<div id="v_${c}" class="value">0</div></div>`
    })
}

function loadValues(p){
    let d=inv()[p]||{}
    campos.forEach(c=>document.getElementById("v_"+c).innerText=(d[c]||0))
    pos=0;buffer="";highlight()
}

let pos=0,buffer=""

function highlight(){
    campos.forEach((c,i)=>document.getElementById("v_"+c).parentNode.classList.toggle("highlight",i===pos))
}
function v(){return +document.getElementById("v_"+campos[pos]).innerText||0}
function set(x){document.getElementById("v_"+campos[pos]).innerText=x}

document.getElementById("prev").onclick=()=>{pos=(pos-1+campos.length)%campos.length;buffer="";highlight()}
document.getElementById("next").onclick=()=>{pos=(pos+1)%campos.length;buffer="";highlight()}
document.getElementById("plus").onclick=()=>{buffer+="+";mostrar()}
document.getElementById("clear").onclick=()=>{buffer="";set(0)}

function keypad(){
    let k=document.getElementById("keys")
    for(let i=1;i<=9;i++){
        let b=document.createElement("button"); b.className="kp";b.innerText=i;
        b.onclick=()=>{ buffer+=i;mostrar() }; k.appendChild(b)
    }
    let z=document.createElement("button");z.className="kp";z.style.gridColumn="span 2";z.innerText="0";
    z.onclick=()=>{buffer+="0";mostrar()};k.appendChild(z)

    let del=document.createElement("button");del.className="kp";del.innerText="⌫";
    del.onclick=()=>{buffer=buffer.slice(0,-1);mostrar()};k.appendChild(del)
}
keypad()

function mostrar(){
    let cur=v(),n=cur
    if(buffer.includes("+")){
        n = cur + buffer.split("+").filter(x=>x).reduce((a,b)=>a+Number(b),0)
    }else if(buffer!=="") n=Number(buffer)
    set(n)
}

document.getElementById("save").onclick=()=>{
    let p=document.getElementById("piso").value
    let data=inv(); data[p]={}
    campos.forEach(c=>data[p][c]=+document.getElementById("v_"+c).innerText)
    saveInv(data); alert("✔ Piso guardado")
}
</script>
</body>
</html>
