<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Stock - Resultados</title>
<style>
body{
    background:#111;
    color:#eee;
    font-size:18px;
    text-align:center;
    padding:10px;
    font-family:Arial;
}
button{
    width:90%;
    font-size:20px;
    margin:10px 0;
    padding:12px;
    border:none;
    background:#0077ff;
    color:white;
    border-radius:8px;
}
pre{
    text-align:left;
    font-size:16px;
    white-space:pre-wrap;
    background:#000;
    color:#0f0;
    border:1px solid #555;
    padding:10px;
    margin-top:15px;
}
</style>
</head>

<body>

<h2>üì¶ CONTROL DE STOCK</h2>
<p>Base + Inventario guardado</p>

<button onclick="calcular()">üìä Calcular</button>
<button onclick="borrar()">üóë Borrar Inventario</button>
<button onclick="location.href='inventario.html'">üì• Cargar Inventario</button>

<pre id="salida">Resultado aparecer√° aqu√≠...</pre>

<script>
// === CARGAR BASE AL INICIAR ===
async function cargarBaseSiFalta(){
    if(localStorage.getItem("lbase")) return;

    try{
        let txt = await fetch("base.txt").then(r=>r.text());
        let l=txt.trim().split("\n").map(x=>x.split(","));
        let h=l[0]; let out={};

        l.slice(1).forEach(r=>{
            let o={}; r.forEach((v,i)=>o[h[i]]=v);
            out[o.piso]={king:+o.king,queen:+o.queen,twin:+o.twin,"3ra_sabana":o["3ra_sabana"]};
        });

        localStorage.setItem("lbase",JSON.stringify(out));

    }catch(e){
        document.getElementById("salida").innerText="‚ö† No se pudo cargar base.txt";
    }
}

// === BOT√ìN CALCULAR ===
async function calcular(){
    await cargarBaseSiFalta(); 

    let base=JSON.parse(localStorage.getItem("lbase")||"{}");
    let inv=JSON.parse(localStorage.getItem("linv")||"{}");

    if(Object.keys(inv).length===0){
        document.getElementById("salida").innerText="‚ö† No hay inventario cargado";
        return;
    }

    let out="üìä RESULTADO\n====================\n";

    for(let p in inv){
        if(!base[p]) continue;

        let i=inv[p],b=base[p];

        // 2 sabanas por cama / la 3ra solo si T
        let SG=b.king*2, SCH=b.queen*2, F=30;

        let SG3=b["3ra_sabana"]=="T"?b.king:0;
        let SCH3=b["3ra_sabana"]=="T"?b.queen:0;
        let K3=b["3ra_sabana"]=="T"?b.twin:0;

        out+=`\nüè® Piso ${p}\n---------------------\n`;
        out+=`B:${i.B}  T:${i.T}  P:${i.P}\n`;
        out+=`SG:${i.SG}/${SG}  SCH:${i.SCH}/${SCH}  F:${i.F}/${F}\n`;
        out+=`3SG:${i["3SG"]}/${SG3}  3SCH:${i["3SCH"]}/${SCH3}  3K:${i["3K"]}/${K3}\n`;
    }

    document.getElementById("salida").innerText=out;
}

// === BORRAR INVENTARIO ===
function borrar(){
    if(confirm("¬øBorrar inventario permanente?")){
        localStorage.removeItem("linv");
        document.getElementById("salida").innerText="Inventario eliminado";
    }
}

cargarBaseSiFalta();
</script>
</body>
</html>
