<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Stock</title>

<style>
body{
    background:#0b0b0b;
    color:#eee;
    font-size:18px;
    text-align:center;
    font-family:Arial;
}
/* --- BOTONES --- */
button{
    width:90%;
    font-size:20px;
    margin:12px 0;
    padding:13px;
    border:none;
    background:#0077ff;
    color:white;
    border-radius:8px;
}

/* --- TABLA RESULTADO --- */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #444;
    padding:6px;
    font-size:15px;
}
th{background:#0044aa;}
tr:nth-child(even){background:#111;}
tr:nth-child(odd){background:#1b1b1b;}
</style>
</head>

<body>

<h2>ðŸ“¦ CONTROL DE STOCK</h2>

<button onclick="calcular()">ðŸ“Š Calcular</button>
<button onclick="borrar()">ðŸ—‘ Borrar Inventario</button>
<button onclick="location.href='inventario.html'">ðŸ“¥ Cargar Inventario</button>

<div id="resultado">Esperando datos...</div>

<script>

/* =====================
     CARGA DE BASE.TXT
===================== */
async function cargarBaseSiFalta(){
    if(localStorage.getItem("lbase")) return; // ya existe, no recargar

    try{
        let txt = await fetch("base.txt").then(r=>r.text());
        let l=txt.trim().split("\n").map(x=>x.split(","));
        let h=l[0]; 
        let out={};

        l.slice(1).forEach(r=>{
            let o={}; r.forEach((v,i)=>o[h[i]]=v);
            out[o.piso]={king:+o.king,queen:+o.queen,twin:+o.twin,"3ra_sabana":o["3ra_sabana"]};
        });

        localStorage.setItem("lbase",JSON.stringify(out));
    }
    catch(e){
        document.getElementById("resultado").innerHTML="<b style='color:red'>âš  No se pudo cargar base.txt</b>";
    }
}

/* =====================
          CALCULAR
===================== */
async function calcular(){
    await cargarBaseSiFalta(); 

    let base=JSON.parse(localStorage.getItem("lbase")||"{}");
    let inv=JSON.parse(localStorage.getItem("linv")||"{}");

    if(Object.keys(inv).length===0){
        document.getElementById("resultado").innerHTML=
        "<b style='color:red'>âš  No hay inventario cargado</b>";
        return;
    }

    // ENCABEZADO DE TABLA
    let html=`
    <table>
    <tr>
        <th>PISO</th>
        <th>B</th><th>T</th><th>P</th>
        <th>SG</th><th>SCH</th><th>F</th>
        <th>3SG</th><th>3SCH</th><th>3K</th>
    </tr>`;

    // POR CADA PISO GUARDADO
    for(let p in inv){
        if(!base[p]) continue; // si no existe en base, no mostrar

        let i=inv[p], b=base[p];

        // Calcular lo necesario para habitaciÃ³n completa
        let SG=b.king*2;
        let SCH=b.queen*2;
        let F=30;

        let SG3=b["3ra_sabana"]=="T"?b.king:0;
        let SCH3=b["3ra_sabana"]=="T"?b.queen:0;
        let K3=b["3ra_sabana"]=="T"?b.twin:0;

        html+=`
        <tr>
            <td><b>${p}</b></td>
            <td>${SG - i.SG}</td>
            <td>${SCH - i.SCH}</td>
            <td>${F - i.F}</td>
            <td>${SG - i.SG}</td>
            <td>${SCH - i.SCH}</td>
            <td>${F - i.F}</td>
            <td>${SG3 - i["3SG"]}</td>
            <td>${SCH3 - i["3SCH"]}</td>
            <td>${K3 - i["3K"]}</td>
        </tr>`;
    }

    html+="</table>";
    document.getElementById("resultado").innerHTML=html;
}

/* =====================
    BORRAR INVENTARIO
===================== */
function borrar(){
    if(confirm("Â¿Eliminar inventario guardado?")){
        localStorage.removeItem("linv");
        document.getElementById("resultado").innerHTML="Inventario eliminado";
    }
}

cargarBaseSiFalta();
</script>

</body>
</html>
