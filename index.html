<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Control Stock FINAL (fix terceras)</title>
<style>
:root{ --bg:#0d1117; --t1:#161b22; --t2:#1e242c; --th:#0052cc; --ok:#00ff88; --zero:#606060; --accent:#02afff; --danger:#e63939; }
body{background:var(--bg);color:#eee;margin:0;font-family:Arial}
h1{text-align:center;font-size:22px;margin-top:12px;font-weight:800}
button{ width:94%;padding:16px;margin:12px auto;display:block; font-size:20px;font-weight:bold;border:none;border-radius:10px;color:white;}
.b1{background:var(--accent);} .b2{background:#777;} .b3{background:var(--danger);}
.tablewrap{overflow-x:auto;margin-top:15px}
table{width:100%;border-collapse:collapse;min-width:1000px}
th,td{border:1px solid #333;text-align:center;padding:6px 4px;font-size:15px}
th{background:var(--th);color:white;position:sticky;top:0;z-index:2;}
tr:nth-child(even){background:var(--t1);} tr:nth-child(odd){background:var(--t2);}
td.piso{font-weight:800;color:var(--accent)}
.need{color:var(--ok);font-weight:900;font-size:16px}
.zero{color:var(--zero)}
.inv{color:#999;font-size:12px}
#msg{text-align:center;font-size:14px;margin-top:5px;color:#aaa}
</style>
</head>
<body>

<div style="max-width:1000px;margin:auto;padding:10px">
  <h1>üì¶ CONTROL DE STOCK ‚Äî CANTIDADES A LLEVAR</h1>
  <button class="b1" onclick="calcular()">üìä CALCULAR</button>
  <button class="b2" onclick="location.href='inventario.html'">‚úç CARGAR INVENTARIO</button>
  <button class="b3" onclick="borrar()">üóë BORRAR INVENTARIO</button>

  <div id="msg">Esperando datos...</div>
  <div class="tablewrap" id="tbl"></div>
</div>

<script>
async function loadBase(){
  if(localStorage.getItem("lbase")) return JSON.parse(localStorage.getItem("lbase"));
  const txt = await fetch("base.txt").then(r=>r.text());
  const L = txt.trim().split("\n").map(l=>l.split(","));
  const h = L[0];
  const o = {};
  L.slice(1).forEach(r=>{
    const x = {};
    r.forEach((v,i)=> x[h[i]] = v);
    if(x.piso) o[x.piso] = { king: +x.king, queen: +x.queen, twin: +x.twin, tercera: x["3ra_sabana"] === "T" };
  });
  localStorage.setItem("lbase", JSON.stringify(o));
  return o;
}

function loadInv(){ return JSON.parse(localStorage.getItem("linv") || "{}"); }
function borrar(){ if(confirm("¬øELIMINAR INVENTARIO?")){ localStorage.removeItem("linv"); document.getElementById("tbl").innerHTML = ""; document.getElementById("msg").innerText = "Inventario eliminado"; } }

function F(req, have){
  const need = req - have;
  return need > 0 ? `<b class='need'>${need}</b> <span class='inv'>(${have})</span>` : `<span class='zero'>0</span> <span class='inv'>(${have})</span>`;
}

async function calcular(){
  const base = await loadBase();
  const inv = loadInv();
  if(!Object.keys(inv).length){ document.getElementById("msg").innerText = "‚ö† Sin inventario cargado"; return; }

  let H = `<table><tr>
    <th>Piso</th><th>B</th><th>T</th><th>P</th>
    <th>SG (Queen)</th><th>SCH (Twin)</th><th>K (King)</th>
    <th>3SG</th><th>3SCH</th><th>3K</th>
  </tr>`;

  for(const p of Object.keys(inv)){
    if(!base[p]) continue;
    const b = base[p];
    const i = inv[p] || {};
    const ocup = +(i.ocupacion ?? 0);

    // Requeridos
    const reqB = 2 * ocup;
    const reqT = 2 * ocup;
    const reqP = 16;
    const reqSG = b.queen * 2;
    const reqSCH = b.twin * 2;
    const reqK = b.king * 2;
    const req3SG = b.tercera ? b.queen : 0;
    const req3SCH = b.tercera ? b.twin : 0;
    const req3K = b.tercera ? b.king : 0;

    // Inventario (USAR ?? antes de + para evitar NaN)
    const B   = +(i.B   ?? 0);
    const T   = +(i.T   ?? 0);
    const P   = +(i.P   ?? 0);
    const SG  = +(i.SG  ?? 0);
    const SCH = +(i.SCH ?? 0);
    const K   = +(i.K   ?? 0);
    const SG3 = +(i["3SG"]  ?? 0);
    const SCH3= +(i["3SCH"] ?? 0);
    const K3  = +(i["3K"]   ?? 0);

    H += `<tr>
      <td class='piso'>${p}</td>
      <td>${F(reqB, B)}</td>
      <td>${F(reqT, T)}</td>
      <td>${F(reqP, P)}</td>
      <td>${F(reqSG, SG)}</td>
      <td>${F(reqSCH, SCH)}</td>
      <td>${F(reqK, K)}</td>
      <td>${F(req3SG, SG3)}</td>
      <td>${F(req3SCH, SCH3)}</td>
      <td>${F(req3K, K3)}</td>
    </tr>`;
  }

  H += `</table>`;
  document.getElementById("tbl").innerHTML = H;
  document.getElementById("msg").innerText = "‚úî Lista generada con valores y (stock)";
}
</script>
</body>
</html>
